day24 :: (input: string) -> string, string
{
    part1, part2 := 0;

    state := 0;
    seen : Table(s64, u8);
    layer, next_layer : [401]s64;

    i := 0;
    for c: input {
        if c == "\n" continue;
        defer i += 1;
        if c == "." continue;
        state      |= 1 << i;
        layer[200] |= 1 << i;
    }

    while true {
        _, new := find_or_add(*seen, state);
        if !new break;

        next := 0;
        for 0..24 {
            cell := state & (1 << it);
            count := popcount(state & neighbours[it]);
            if count == 1 || (cell == 0 && count == 2) next |= 1 << it;
        }
        state = next;
        part1 = state;
    }

    for step: 0..199 {
        for l: 200-step..200+step {
            inner := layer[l + 1];
            level := layer[l];
            outer := layer[l - 1];

            next_layer[l] = 0;
            for 0..24 {
                if it == 12 continue;
                cell := level & (1 << it);
                count := popcount(inner & inner_neighbours[it]);
                count += popcount(level & level_neighbours[it]);
                count += popcount(outer & outer_neighbours[it]);
                if count == 1 || (cell == 0 && count == 2) next_layer[l] |= 1 << it;
            }
        }
        swap(*layer, *next_layer);
    }

    for layer part2 += popcount(it);

    return tprint("%", part1), tprint("%", part2);
}

#scope_file

neighbours :: s64.[
    0b0000000000000000000100010,
    0b0000000000000000001000101,
    0b0000000000000000010001010,
    0b0000000000000000100010100,
    0b0000000000000001000001000,
    0b0000000000000010001000001,
    0b0000000000000100010100010,
    0b0000000000001000101000100,
    0b0000000000010001010001000,
    0b0000000000100000100010000,
    0b0000000001000100000100000,
    0b0000000010001010001000000,
    0b0000000100010100010000000,
    0b0000001000101000100000000,
    0b0000010000010001000000000,
    0b0000100010000010000000000,
    0b0001000101000100000000000,
    0b0010001010001000000000000,
    0b0100010100010000000000000,
    0b1000001000100000000000000,
    0b0001000001000000000000000,
    0b0010100010000000000000000,
    0b0101000100000000000000000,
    0b1010001000000000000000000,
    0b0100010000000000000000000,
];

level_neighbours :: s64.[
    0b0000000000000000000100010,
    0b0000000000000000001000101,
    0b0000000000000000010001010,
    0b0000000000000000100010100,
    0b0000000000000001000001000,
    0b0000000000000010001000001,
    0b0000000000000100010100010,
    0b0000000000000000101000100,
    0b0000000000010001010001000,
    0b0000000000100000100010000,
    0b0000000001000100000100000,
    0b0000000010000010001000000,
    0b0000000100010100010000000,
    0b0000001000100000100000000,
    0b0000010000010001000000000,
    0b0000100010000010000000000,
    0b0001000101000100000000000,
    0b0010001010000000000000000,
    0b0100010100010000000000000,
    0b1000001000100000000000000,
    0b0001000001000000000000000,
    0b0010100010000000000000000,
    0b0101000100000000000000000,
    0b1010001000000000000000000,
    0b0100010000000000000000000,
];

outer_neighbours :: s64.[
    0b0000000000000100010000000,
    0b0000000000000000010000000,
    0b0000000000000000010000000,
    0b0000000000000000010000000,
    0b0000000000010000010000000,
    0b0000000000000100000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000010000000000000,
    0b0000000000000100000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000010000000000000,
    0b0000000000000100000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000010000000000000,
    0b0000000100000100000000000,
    0b0000000100000000000000000,
    0b0000000100000000000000000,
    0b0000000100000000000000000,
    0b0000000100010000000000000,
];

inner_neighbours :: s64.[
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000011111,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000100001000010000100001,
    0b0000000000000000000000000,
    0b1000010000100001000010000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b1111100000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
    0b0000000000000000000000000,
];